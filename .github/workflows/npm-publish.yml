# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: Publish to npm

# 触发条件：满足以下任一条件时执行自动发布
on:
  # 1. 推送符合语义化版本的tag（如v1.0.0、v2.1.3）时触发（推荐）
  push:
    tags:
      - 'v1.*.*'
  # 2. 手动触发（可选，在GitHub Actions页面点击Run workflow即可执行）
  workflow_dispatch:

# 定义要执行的任务
jobs:
  publish:
    # 运行环境：最新版Ubuntu（GitHub提供的虚拟环境）
    runs-on: ubuntu-latest
    # 关键：必须设置 id-token 权限为 write，用于获取 OIDC 令牌
    permissions:
      id-token: write  # 核心权限，不可省略
      contents: read   # 读取仓库内容

    # 任务步骤
    steps:
      # 步骤1：拉取GitHub仓库的代码到虚拟环境
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：配置Node.js环境（指定版本，和项目兼容）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 根据你的项目选择Node版本（如18、22）
          registry-url: https://registry.npmjs.org/  # 强制使用npm官方源，避免镜像源问题

      # 步骤3：安装项目依赖（CI环境推荐用npm ci，比npm install更稳定）
      - name: Install dependencies
        run: npm ci

      # 步骤4：代码检查（ESLint）
      - name: Lint code
        run: npm run lint

      # 步骤5：运行测试（Vitest）
      - name: Run tests
        run: npm run test

      # 步骤6：构建项目（TS转JS）
      - name: Build project
        run: npm run build

      # 步骤7：核心步骤——发布到npm
      - name: Publish to npm
        # 使用 npm 官方的 publish 命令，自动通过 OIDC 验证
        run: npm publish --provenance --access public
        # 注意：如果是私有包，去掉 --access public；--provenance 可选，用于生成发布溯源信息
