# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: Publish to npm

# 触发条件：满足以下任一条件时执行自动发布
on:
  # 1. 推送符合语义化版本的tag（如v1.0.0、v2.1.3）时触发（推荐）
  push:
    tags:
      - 'v*.*.*'
  # 2. 手动触发（可选，在GitHub Actions页面点击Run workflow即可执行）
  workflow_dispatch:

# 定义要执行的任务
jobs:
  publish:
    # 运行环境：最新版Ubuntu（GitHub提供的虚拟环境）
    runs-on: ubuntu-latest
    # 任务步骤
    steps:
      # 步骤1：拉取GitHub仓库的代码到虚拟环境
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：配置Node.js环境（指定版本，和项目兼容）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 根据你的项目选择Node版本（如18、22）
          registry-url: https://registry.npmjs.org/  # 强制使用npm官方源，避免镜像源问题

      # 步骤3：安装项目依赖（CI环境推荐用npm ci，比npm install更稳定）
      - name: Install dependencies
        run: npm ci

      # （可选）步骤4：如果项目需要构建（如TS转JS、打包），添加构建命令
      # - name: Build project
      #   run: npm run build

      # （可选）步骤5：代码校验/测试（确保发布前代码无问题）
      # - name: Lint code
      #   run: npm run lint
      # - name: Run tests
      #   run: npm test

      # 步骤6：核心步骤——发布到npm
      - name: Publish to npm
        run: npm publish --access public  # 作用域包（@用户名/包名）必须加--access public，普通包可省略
        env:
          # 从GitHub Secrets中读取npm令牌，注入环境变量（npm会自动读取这个变量完成登录）
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
